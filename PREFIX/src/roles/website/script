#!/usr/bin/env sh
#website - set up website with nginx or apache
set -eu

echo() { printf "%s" "$*"; }
exists() { command -v "$1" >/dev/null 2>&1; }
die() { if [ "$#" -gt 0 ]; then printf "%s\n" "$*" >&2; fi && exit 1; }
in_dir() (cd "$1" && shift && "$@")
sponge() { set -- "$1" "$(mktemp)" && cat >"$2" && sudo mv "$2" "$1"; }

lineinfile() { #1: path, 2: regexp, 3: line
    [ $# -eq 2 ] && set -- "$1" "^$2\$" "${3:-$2}" || true
    if grep -qF "^$3$" "$1" 2>/dev/null; then
        return
    elif grep -q "$2" "$1" 2>/dev/null; then
        set -- "$1" "$2" "$3" "$(mktemp)"
        <"$1" sed "s/.*$(echo "$2" | sed 's_/_\\/_').*/$(
        )$(echo "$3" | sed 's_/_\\/_')/" >"$4"
        sudo mv "$4" "$1"
    else
        sudo sh -c 'echo "$3" >>"$1"' - "$@"
    fi
}

TEMPLATE="${TEMPLATE:-static}"
FQDN="${FQDN:-$([ -z "${BASE_URL-}" ] \
    || echo "$BASE_URL" | sed -E 's_(https?://)?([^/:]*).*_\2_')}"
URL_PREFIX="${URL_PREFIX:-$([ -z "${BASE_URL-}" ] \
    || echo "$BASE_URL" | sed -E 's_(https?://)?([^/]*)/?__')}"
PORT="${PORT:-$(
    echo "${BASE_URL-}" | sed -E 's_(https?://)?[^/:]*(:([0-8]*))?.*_\3_'
)}"
FILENAME="${FQDN:-localhost}${PORT:+:$PORT}"
LOCATION="${LOCATION:-/srv/http/$FILENAME}"
LEVEL="${LEVEL:-$([ -n "$URL_PREFIX" ] && echo location || echo server)}"
SSL="${SSL:-$(case "${BASE_URL:-}" in
    https://*.ts.net*) echo tailscale ;;
    https://*) [ -n "${LEGO_CMD:-}" ] && echo 'lego' || echo certbot ;;
    *) ;;
    esac)}"

if [ "$TEMPLATE" = reverseproxy ]; then
    : "$PROXY_PASS" #error if unset
elif [ "$TEMPLATE" = php ]; then
    sudo pacman --needed --noconfirm -qS php-fpm
    sudo systemctl enable --now php-fpm
    FASTCGI_PASS=unix:/run/php-fpm/php-fpm.sock
elif [ "$TEMPLATE" = php7 ]; then
    sudo pacman --needed --noconfirm -qS php7-fpm
    sudo systemctl enable --now php-fpm7
    FASTCGI_PASS=unix:/run/php-fpm7/php-fpm.sock
    TEMPLATE=php
elif [ "$TEMPLATE" = static ] || [ "$TEMPLATE" = static-protected ]; then
    sudo mkdir -p "$LOCATION"
fi

case "${HTTPD-nginx}" in
apache)
    if exists pacman; then
        DAEMON=httpd
    elif exists apt-get; then
        DAEMON=apache2
    fi
    [ "$TEMPLATE" = php ] && TEMPLATE=static || :
    sudo mkdir -p "/etc/$DAEMON/templates/"
    sudo cp "website/apache-templates"/* "/etc/$DAEMON/templates/"
    in_dir "/etc/$DAEMON/templates" cat "$TEMPLATE" \
        | sed \
            -e "s/\\\$FQDN/$FQDN/" \
            -e "s/\\\$PORT/${PORT:-80}/" \
            -e "s \\\$LOCATION $LOCATION " \
        | sudo tee "/etc/$DAEMON/sites/$FILENAME.conf" >/dev/null
    cat "/etc/$DAEMON/sites/"*.conf \
        | sed -n 's/<VirtualHost [^: \/]*:\([0-9]*\)>.*/Listen \1/p' \
        | sudo tee "/etc/$DAEMON/ports.conf" >/dev/null
    sudo systemctl restart "$DAEMON"
    ;;
nginx)
    [ "$LEVEL" = server ] || sudo mkdir -p "/etc/nginx/sites/$FILENAME.d"
    sudo mkdir -p "/etc/nginx/templates/"
    sudo cp "website/nginx-templates"/* "/etc/nginx/templates/"
    in_dir "/etc/nginx/templates" cat "$TEMPLATE" \
        | if [ "$LEVEL" = server ]; then
            printf "%s\n" \
                "server {" \
                "    server_name \"$FQDN\";" \
                "    listen ${PORT:-80};" \
                "    include sites/$FILENAME.d/*.conf;"
            sed 's/^/    /'
            printf "}\n"
        else
            sed 's/^/    /'
        fi \
        | sed \
            -e "s/\\\$FILENAME/$FILENAME/" \
            -e "s \\\$URL_PREFIX ${URL_PREFIX} " \
            -e "s/\\\$FQDN/$FQDN/" \
            -e "s/\\\$PORT/${PORT:-80}/" \
            -e "s \\\$PROXY_PASS ${PROXY_PASS-gimme_an_error} " \
            -e "s \\\$FASTCGI_PASS ${FASTCGI_PASS-gimme_an_error} " \
            -e "s \\\$LOCATION $LOCATION " \
        | sudo tee "/etc/nginx/sites/$([ "$LEVEL" = server ] \
            && echo "$FILENAME" \
            || echo "$FILENAME.d/$URL_PREFIX").conf" >/dev/null
    sudo systemctl reload nginx || sudo systemctl restart nginx \
        || ! sudo systemctl is-failed nginx >/dev/null
    ;;
esac

if [ -n "${SSL:-}" ]; then
    echo "$FQDN" | grep -qF . || die "ERROR: Invalid FQDN"
    [ "${HTTPD:-nginx}" = nginx ] \
        || die "ERROR: SSL installation not implemented for $HTTPD"
    sudo mkdir -p /etc/nginx/ssl/
    case "$SSL" in
    tailscale)
        CERT="/etc/nginx/ssl/$FQDN.crt"
        CERT_KEY="/etc/nginx/ssl/$FQDN.key"
        sudo tailscale cert --cert-file "$CERT" --key-file "$CERT_KEY" "$FQDN"
        ;;
    certbot)
        if ! exists certbot; then
            if exists apt-get; then
                sudo apt-get install -yq certbot python3-certbot-nginx
            elif exists pacman; then
                sudo pacman -qS --needed --noconfirm certbot-nginx
            fi
        fi
        CERT="/etc/letsencrypt/live/$FQDN/fullchain.pem"
        CERT_KEY="/etc/letsencrypt/live/$FQDN/privkey.pem"
        if
            ! sudo openssl x509 -in "$CERT" -checkend 2592000 >/dev/null 2>&1
        then
            sudo certbot certonly -n --nginx --agree-tos --no-eff-email \
                -m "root@$FQDN" -d "$FQDN" --cert-name "$FQDN"
        fi
        sudo systemctl enable --now certbot-renew.timer 2>/dev/null \
            || sudo systemctl enable --now certbot.timer 2>/dev/null \
            || die 'ERROR: could not enable certbot renewal timer'
        ;;
    lego)
        if ! exists lego; then
            if exists pacman; then
                sudo pacman -qS --needed --noconfirm lego
            else
                env GO111MODULE=on \
                    go install github.com/go-acme/lego/v4/cmd/lego@latest
            fi
        fi
        if ! id -u "lego" >/dev/null 2>&1; then
            PATH="$PATH:/usr/sbin"
            if exists useradd; then
                sudo useradd -s "/bin/false" -md /usr/share/lego lego
            elif exists adduser; then
                sudo adduser -s "/bin/false" -md /usr/share/lego lego
            fi
        fi
        CERT="/etc/nginx/ssl/$FQDN.crt"
        CERT_KEY="/etc/nginx/ssl/$FQDN.key"
        if
            ! sudo openssl x509 -in "$CERT" -checkend 2592000 >/dev/null 2>&1
        then
            printf %s "$LEGO_CMD" | sudo -u lego \
                env LEGO_PATH=/usr/share/lego sh -
            sudo sh -c 'cp ~lego/certificates/* /etc/nginx/ssl'
        fi
        ;;
    esac
    <"/etc/nginx/sites/$FILENAME.conf" sed -E '/^ *(listen|http2|ssl_)/d' \
        | sed -E "/^ *server_name/a\\$(
            printf \\n && printf '%s\\n' \
                "    listen ${PORT:-443} ssl;" \
                "    listen [::]:${PORT:-443} ssl;" \
                "    http2 on;" \
                "    ssl_certificate \"$CERT\";" \
                "    ssl_certificate_key \"$CERT_KEY\";"
        )" \
        | sponge "/etc/nginx/sites/$FILENAME.conf"
    sudo systemctl reload nginx || sudo systemctl restart nginx || true
fi
