# shellcheck disable=SC2317,SC2329
pgdo() (
    [ "$(uname -s)" = Darwin ] || set -- sudo -u postgres "$@"
    cd /
    "$@"
)

pgsql() { pgdo psql -d postgres -U postgres -tAc "$@"; }

createdevdb() {
    case "$1" in
    postgres://*@*/*)
        set -- "${1#postgres://}"
        set -- "${1%%@*}" "${1#*@}"                       #auth rest
        set -- "${1%%:*}" "${1%%:*}" "${2%%/*}" "${2#*/}" #user pass host db
        [ "$3" = localhost ] || { echo "Can't create db on remote" && exit 1; }
        #TODO: un-urlescape -> sql escape
        [ "0$(pgsql "select 1 from pg_roles where rolname='$1'")" -eq 1 ] \
            || pgsql "create role $1 with login superuser createdb"
        pgsql "alter role $1 with password '$2'"
        [ "0$(pgsql "select 1 from pg_database where datname='$4'")" -eq 1 ] \
            || pgsql "create database \"$4\""
        ;;
    esac
}

macos_start_docker() {
    [ "$(uname -s)" != Darwin ] || pgrep Docker >/dev/null || {
        open -Ra Docker >/dev/null 2>&1 \
            || "${DOTFILES-$PREFIX/dot}/PREFIX/src/roles/docker"
        open -ga Docker
        until docker stats --no-stream >/dev/null 2>&1; do sleep 1; done
    }
}

## dotfiles $DOTFILES
git clone https://milhnl@github.com/milhnl/dotfiles .

## shadow
git clone git@github.com:milhnl/shadow .

## finrust
git clone https://michieleforah@bitbucket.org/eforah/adviseursrust .
git config user.email "michiel@eforah.nl"
git switch develop
make env
### cd
run() (
    set -eu
    ssh iau -NTL 1433:localhost:1433 '
        docker start mssql-server >/dev/null 2>&1 \
            || docker run --name=mssql-server -e ACCEPT_EULA=Y \
            -e MSSQL_SA_PASSWORD=P.ssw0rd -p 1433:1433 \
            -d mcr.microsoft.com/azure-sql-edge:latest
    '
    cd "$(workspace dir-of finrust)"
    make env
    if [ "${1-}" = --prod ] || [ "${1-}" = --production ]; then
        dotnet publish --configuration Release
        export ASPNETCORE_ENVIRONMENT=Production
    else
        dotnet build --configuration Debug
    fi
    notify-send "Finrust" "running"
    (sh -c 'sleep 3; curl -q localhost:5000' >/dev/null 2>&1 &)
    sh -ac '
        . .env
        cd src/WebUi
        "bin/net$(<../../global.json jq -r '.sdk.version')/Finrust.WebUi" &
        export pid=$!
        really_stop() {
            kill -TERM "$pid" 2>/dev/null
            (sh -xc "sleep 1; kill -KILL "$pid";" >/dev/null 2>&1 &)
        }
        trap really_stop EXIT INT TERM
        cat
    '
)

## proxyrust
git clone https://michieleforah@bitbucket.org/eforah/proxyrust .
git config user.email "michiel@eforah.nl"

## flexcard
git clone https://milhnl@github.com/gloedonline/flexcard .
git config user.email "michiel@eforah.nl"

## participatietool
git clone https://michieleforah@bitbucket.org/eforah/participatietool .
git config user.email "michiel@eforah.nl"
### cd
export ARM_SUBSCRIPTION_ID="08de1cd1-0868-4f28-8edb-19d87383afdd"

## ledger

## firefox_cli
git clone https://milhnl@github.com/milhnl/firefox_cli .

## pmmux
git clone https://milhnl@github.com/milhnl/pmmux .

## netnix
git clone https://milhnl@github.com/milhnl/netnix .

## workspace
git clone https://milhnl@github.com/eforah-oss/workspace .

## pass
git clone --recursive https://milhnl@github.com/milhnl/pass .
git switch -t origin/zsh-completion

## mpmc
git clone https://milhnl@github.com/milhnl/mpmc .

## rubbersheet
git clone https://milhnl@github.com/milhnl/rubbersheet .

## timon_dotfiles
git clone https://milhnl@github.com/Dyxos/dotfiles.git .

## qmk_firmware
git clone -b milhnl --single-branch --recurse-submodules \
    https://milhnl@github.com/milhnl/qmk_firmware .
git remote add -t master -f upstream https://github.com/qmk/qmk_firmware
pmmux -1 brew+'qmk/qmk/qmk avr-gcc arm-none-eabi-gcc' pacman+qmk
#qmk setup -H "$PWD" -b milhnl milhnl/qmk_firmware
[ "$(uname -s)" = Darwin ] || sudo usermod -aG uucp mil
### cd
flash_left() { sudo make lily58:milhnl:dfu-split-left; }
flash_right() { sudo make lily58:milhnl:dfu-split-right; }
echo "Use flash_{left,right} to apply to keyboard" >&2

## judo ${XDG_DATA_HOME}/go/src/judo
git clone https://milhnl@github.com/milhnl/judo .
git config commit.gpgsign true
git remote add upstream https://github.com/rollcat/judo
git pull upstream master

## website_eforah
git clone https://michieleforah@bitbucket.org/eforah/website_eforah.git .

## yubikey-pgp
git clone https://milhnl@github.com/Eforah-oss/yubikey-pgp.git .

## pregame
git clone https://milhnl@github.com/milhnl/pregame .

## vis-backspace ${XDG_CONFIG_HOME}/vis/vis-backspace
git clone https://milhnl@github.com/milhnl/vis-backspace.git .

## vis-crlf ${XDG_CONFIG_HOME}/vis/vis-crlf
git clone --recurse-submodules https://github.com/milhnl/vis-crlf.git .

## vis-editorconfig-options ${XDG_CONFIG_HOME}/vis/vis-editorconfig-options
git clone https://milhnl@github.com/milhnl/vis-editorconfig-options .

## vis-filetype-options ${XDG_CONFIG_HOME}/vis/vis-filetype-options
git clone https://milhnl@github.com/milhnl/vis-filetype-options .

## vis-format ${XDG_CONFIG_HOME}/vis/vis-format
git clone https://milhnl@github.com/milhnl/vis-format .

## vis-lspc ${XDG_CONFIG_HOME}/vis/vis-lspc
git clone https://milhnl@gitlab.com/milhnl/vis-lspc.git .
git remote add upstream https://gitlab.com/muhq/vis-lspc.git
git pull upstream main

## vis-modeline-options ${XDG_CONFIG_HOME}/vis/vis-modeline-options
git clone https://milhnl@github.com/milhnl/vis-modeline-options .

## vis-options-backport ${XDG_CONFIG_HOME}/vis/vis-options-backport
git clone https://milhnl@github.com/milhnl/vis-options-backport .

## vis-sudoedit ${XDG_CONFIG_HOME}/vis/vis-sudoedit
git clone https://milhnl@github.com/milhnl/vis-sudoedit .

## vis-term-title ${XDG_CONFIG_HOME}/vis/vis-term-title
git clone https://milhnl@github.com/milhnl/vis-term-title .

## alot
git clone https://milhnl@github.com/milhnl/alot .
git remote add upstream https://github.com/pazz/alot
git pull upstream master

python3.13 -m venv --system-site-packages .venv
.venv/bin/python -m pip install --upgrade pip
.venv/bin/pip install -e .
.venv/bin/pip install python-lsp-server pylsp-mypy #uv can't resolve deps

### cd
run() { ./.venv/bin/python -m alot "$@"; }

## pimsync
git clone https://git.sr.ht/~whynothugo/pimsync .

## vis
git clone https://github.com/martanne/vis .
git remote add rnpnr https://github.com/rnpnr/vis
git remote add milhnl https://github.com/milhnl/vis

## docworks
git clone https://milhnl@github.com/eforah-oss/docworks .

## tasmodo
git clone https://milhnl@github.com/milhnl/tasmodo .

## apinfo
git clone https://milhnl@github.com/milhnl/apinfo .

## getopts
git clone https://milhnl@github.com/milhnl/getopts .

## txtconv
git clone https://github.com/milhnl/txtconv.git .

## upwardfind
git clone https://github.com/milhnl/upwardfind .

## energycost
name="$(basename "$PWD")"
export DATABASE_URL="postgres://$name@localhost/$name"
createdevdb postgres://energycost@localhost/energycost
cargo install sqlx-cli

### cd
name="$(basename "$PWD")"
export DATABASE_URL="postgres://$name@localhost/$name"
! [ -e .env ] || . .env

## starling-provisioning-backend
git clone https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/Provisioning .
git s develop
cp .env.example .env
printf '%s\n' \
    'DEBUG=TRUE' \
    'PROVISIONING_DB_ENGINE=django.db.backends.postgresql' \
    'PROVISIONING_DB_NAME=starling-provisioning' \
    'PROVISIONING_DB_HOST=localhost' \
    'PROVISIONING_DB_USER=starling' \
    'PROVISIONING_DB_PASS=starling' \
    >>.env
pmmux -1 brew+'mariadb postgresql' pacman+'mariadb-libs postgresql-libs'
python3.12 -m venv .venv
./.venv/bin/pip install -e .

createdevdb postgres://starling:starling@localhost/starling-provisioning
./.venv/bin/python src/manage.py migrate

>"$(git rev-parse --git-dir)/hooks/pre-commit" printf "%s\n" \
    '#!/usr/bin/env sh' \
    'set -eu' \
    'ruff check' \
    'ruff format --check'
chmod +x "$(git rev-parse --git-dir)/hooks/pre-commit"

### cd
run() { ./.venv/bin/python src/manage.py runserver; }

## starling-provisioning-frontend
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/Provisioning%20frontend .
printf '%s\n' \
    'PROVISIONING_SERVER=http://localhost:8000' \
    'MSAL_CLIENT_ID=c663b9a8-2b44-440f-b154-5df4e78aaed4' \
    'MSAL_TENANT_ID=22d03ebf-375a-4391-b009-26b750660f83' \
    'MSAL_HOST=http://localhost:4200' \
    >.env
npm i

### cd
run() { npx ng serve; }

## starling-joint
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/joint .
git switch develop
pmmux -1 brew+'mosquitto telegraf' pacman+'mosquitto'
<.env.example sed -E '
    s/^(INFLUX_HOST=).*/\1localhost/
    s/^(INFLUX_DATABASE=).*/\1starling-joint/
    s/^(INFLUX_USER=).*/\1root/
    s/^(INFLUX_PASSWORD=).*/\1root/
    s/^(CLOUD_MQTT_PROTOCOL=).*/\1mqtt/
    s/^(CLOUD_MQTT_HOST=).*/\1localhost/
    s/^(LOCAL_MQTT_HOST=).*/\1localhost/
    s/^(ASSET_ID=).*/\1R0000/
    s/^(DEVICE_ID=).*/\171AC/
    s/^(FEATURE_DATALINK=).*/\1true/
    s/^(FEATURE_PROVISIONING_LINK=).*/\1true/
' >.env
npm ci
macos_start_docker
[ -n "$(docker ps -aq --filter name='^/influxdb-1.8$')" ] \
    || docker run --name=influxdb-1.8 \
        -p 8086:8086 \
        -d influxdb:1.8
docker start influxdb-1.8 >/dev/null
sleep 2
docker exec influxdb-1.8 influx -execute "create database \"starling-joint\""

### cd
macos_start_docker
(exec docker start influxdb-1.8 >/dev/null 2>&1 &)
run() { npm run dev; }

## starling-hmi
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/HMI .

### cd
run() { npx ng serve; }

## starling-iotlink
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/IoT%20Link .
python3.12 -m venv .venv
./.venv/bin/pip install -r requirements.txt

## starling-localinstallation
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/Local%20installation .

## starling-toolbox
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/IoT/_git/RevPi_Toolbox .

## starling-core
git clone --recurse-submodules https://m.vandenheuvel@dev.azure.com/$(
)Bredenoord/Starling/_git/Starling%20core .

# vi: ft=bash
