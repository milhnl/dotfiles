#!/usr/bin/env sh
#editor - pick the right editor and launch it
set -eu

exists() { command -v "$1" >/dev/null 2>&1; }

get_exe() {
    if [ "$(uname -s)" = Darwin ] && exists /usr/local/bin/vis; then
        echo /usr/local/bin/vis
    elif [ "$(uname -s)" = Darwin ] && exists /opt/homebrew/bin/vise; then
        echo /opt/homebrew/bin/vise
    elif [ "$(uname -s)" != Darwin ] && exists vis; then
        command -v vis
    else
        false
    fi
}

ewrap1() {
    if get_exe >/dev/null; then
        [ -z "${command-}" ] || set -- "$command" -- "$@"
        exec "$(get_exe)" "$@"
    elif exists vim; then
        exec vim "$@"
    else
        exec vi "$@"
    fi
}

existing_parent() {
    while ! [ -e "$1" ] && ! [ "$1" = . ]; do
        set -- "$(dirname "$1")"
    done
    echo "$1"
}

mkdir_p_own() { #1 path; $user
    if ! [ -d "$2" ] && ! [ "$2" = . ]; then
        mkdir_p_own "$1" "$(dirname "$2")" || return 1
        mkdir "$2" || return 1
        chown "$1" "$2" || return 1
    fi
}

ewrap0() {
    #Ensure exists
    if [ ! -d "$(dirname "${1-}")" ]; then
        printf "Create directory $(dirname "$1")? [Y/n] " >&2
        read -r REPLY
        [ "$REPLY" != n ] && [ "$REPLY" != N ] || exit 1
    fi
    ls -ld "$(existing_parent "${1-.}")" | {
        read _ _ user group _
        mkdir_p_own "$user:$group" "$(dirname "${1-}")" || exit 1
        [ -e "${1-}" ] \
            || [ "$(id -un):$(id -gn)" = "$user:$group" ] \
            || { touch -- "$1"; chown "$user:$group" "$1"; }
    }
    #Ensure correct newline encoding and no BOM
    encoding="$(cat "${1-}" 2>/dev/null | txtconv -p)"
    if [ -f "${1-}" ] && [ -n "$encoding" ]; then
        txtconv -i "$1"
        (ewrap1 "$@")
        txtconv -i"$encoding" "$1"
    else
        ewrap1 "$@"
    fi
}

git_clone_idempotent() {
    [ -d "$2" ] || git clone "$1" "$2"
}

editor() {
    if ! get_exe >/dev/null; then
        pmmux -1 \
            apk+vis \
            apt+vis \
            brew!'
                brew install pkg-config libtermkey lpeg lua
                pmmux -1 git!"https://github.com/martanne/vis master \
                    git switch --detach 6f537f3
                    ./configure --enable-lpeg-static=no
                    make
                    sudo make install
                "
            ' \
            dnf+vis \
            pacman!'
                sudo pacman --needed --noconfirm --asdeps -qS \
                    libtermkey tre unibilium lua lua-lpeg
                pmmux -1 git!"https://github.com/martanne/vis master \
                    git switch --detach 6f537f3
                    ./configure
                    make
                    sudo make install
                "
            '
        git_clone_idempotent https://milhnl@github.com/milhnl/vis-backspace \
            "$XDG_CONFIG_HOME/vis/vis-backspace"
        git_clone_idempotent https://github.com/erf/vis-cursors.git \
            "$XDG_CONFIG_HOME/vis/vis-cursors"
        git_clone_idempotent \
            https://milhnl@github.com/milhnl/vis-editorconfig-options.git \
            "$XDG_CONFIG_HOME/vis/vis-editorconfig-options"
        git_clone_idempotent \
            https://milhnl@github.com/milhnl/vis-filetype-options.git \
            "$XDG_CONFIG_HOME/vis/vis-filetype-options"
        git_clone_idempotent https://milhnl@github.com/milhnl/vis-format \
             "$XDG_CONFIG_HOME/vis/vis-format"
        git_clone_idempotent https://gitlab.com/muhq/vis-lspc \
            "$XDG_CONFIG_HOME/vis/vis-lspc"
        git_clone_idempotent \
            https://milhnl@github.com/milhnl/vis-options-backport \
            "$XDG_CONFIG_HOME/vis/vis-options-backport"
        git_clone_idempotent \
            https://milhnl@github.com/milhnl/vis-term-title \
            "$XDG_CONFIG_HOME/vis/vis-term-title"
    fi
    if [ -n "${1-}" ] && [ "${1#+}" != "$1" ]; then
        command="$1"
        shift
    fi
    [ ".${1-}" != .-- ] || shift
    if ([ -n "${1-}" ] && [ -e "$1" ] && ! [ -w "$1" ]) \
            || ([ -n "${1-}" ] && ! [ -w "$(existing_parent "$1")" ]); then
        exec sudo env \
            XDG_CONFIG_HOME="$XDG_CONFIG_HOME" \
            XDG_DATA_HOME="$XDG_DATA_HOME" \
            VIS_PATH="$XDG_CONFIG_HOME/vis" \
            PATH="\$PATH:$PATH" \
            "$(command -v editor)" "$@"
    else
        ewrap0 "$@"
    fi
}

editor "$@"
